---
layout: pages/blog-post.pug
title: Create an advanced plugin for Nera
description: Let me show you how to create an advanced plugin which uses tags for different elements on a Nera website
banner_image: /img/banner/plugin-banner.jpg
teaser_image: /img/for-developers/create-advanced-plugin/advanced-plugin-teaser.jpg
author: Michael Becker
tags: advanced, plugin, development
homepage_teaser_content: 3
popular_post: 1
for_developers: 2
---
Nera is a light weight static site generator and I will share how to build a plugin for it here.

## Tags

In my former post I described how easy it is to [create a simple plugin for Nera](/for-developers/plugins/create-simple-plugin.html). In this post I would like to show you how to create a bit more advanced plugin. It should be a plugin which uses given tags of a post or page and creates a tag cloud, a tag link list and tag overview pages for each tag.

Please see how to setup an improvised plugin dev environment for Nera for now in the post I mentioned above.

I will start using my "dev setup", with a default Nera installation and create a folder `src/plugins/tags`.

As for the simple plugin I start with the `index.js` file and this time I will need both functions `addAppData()` and `addMetaData()`.

```javascript
// src/plugins/tags/index.js

const { getConfig } = require('../plugin-helper')

module.exports = (() => {
    const config = getConfig(`${__dirname}/config/tags.yaml`)

    const getAppData = data => {
        // data.app manipulation goes here

        return data.app
    }

    const getMetaData = data => {
        // meta data manipulation of each relevant page goes here

        return data.pagesData
    }

    return {
        getAppData,
        getMetaData
    }
})()
```

Every Nera plugin must include either the `getAppData()` or the `getMetaData()` function or both, where `data.app` or `data.pageData` need to be returned.  
In addition some configuration from the related s`rc/plugins/tags/config/package-name.yaml` file can be imported. Since I want to create a plugin which handles the tags of a page I named the plugin just "tags" and therefore import the `src/plugins/tags/config/tags.yaml`.

* * *

So I will implement the functionality for the tag link list at first. For this the plugin should look for a given property in the pages meta section which includes one or more tags. Then these tags should be added to an array where later the data of this array can be used to create a list of links which point to the related tag overview page.

```javascript
// src/plugins/tags/index.js

const { getConfig } = require('../plugin-helper')

module.exports = (() => {
    const config = getConfig(`${__dirname}/config/tags.yaml`)
    const metaPropertyName = config.meta_property_name || 'tags'
    const tagSeparator = config.tag_separator || ','
    const tagOverviewPath = config.tag_overview_path || ''
    
    const getTagHref = (path, tag) => `${path}/${tag.toLowerCase()}.html`

    const getTagLinks = tags => {
        if (!tags) return []

        return tags.split(tagSeparator).map(tag => ({
            name: tag.trim(),
            href: getTagHref(tagOverviewPath, tag.trim())
        }))
    }


    const getAppData = data => {
        // data.app manipulation goes here

        return data.app
    }

    const getMetaData = data => {
        if (data.pagesData !== null && typeof data.pagesData === 'object') {
            data.pagesData = data.pagesData.map(({ content, meta }) => ({
                content,
                meta: Object.assign({}, meta, {
                    tagLinks: getTagLinks(meta[metaPropertyName])
                })
            }))
        }

        return data.pagesData
    }

    return {
        getAppData,
        getMetaData
    }
})()
```

At first I create three new variables. For the name of the property I will look for on the pages meta section, the separator by which the tags are separated and the path to the tag overview page. All three values can be set in the config file of my plugin, but I also provide default values so the user doesn't need to setup anything for this.

Since the tag link list should be available for every page with tags, I need to loop through the `data.pagesData` in the `getMetaData()` function. Within the loop I will add a new property to the meta section of each page, called `tagLinks`. This property will get its value from the `getTagLinks()` function.

The `getTagLinks()` function receives the value of the tags and returns either an empty array, if there are no tags present or will return an array of small objects with name of the tag and the link to the tags overview page. The link is generated by the `getTagHref()` function which takes path and tag to return the href to the related tag overview page.

In addition I provide a pug file as an easy to use template for the tag link list.

```pug
//- src/plugins/tags/views/partials/tag-link-list.pug

if meta.tagLinks.length > 0
    each link in meta.tagLinks
        a(href=link.href) #{ link.name }
```

To test the tag link list I also create three test pages, with only minimal meta data and content.

![Screenshot of example page for tag link list plugin](/img/for-developers/create-advanced-plugin/Screenshot-of-example-page-for-tag-link-list-plugin.png)

If I include `src/plugins/tags/views/tag-link-list.pug` in the default page template and start compiling with `npm start` and serve the pages on the dev server with `npm run serve` I see the following on [http://127.0.0.1:8080](http://127.0.0.1:8080).

![Screenshot of example page with tag link list](/img/for-developers/create-advanced-plugin/Screenshot-of-example-page-with-tag-link-list.png)

* * *

The next part I would like to add to my plugin is the tag cloud element. It's basically also just a collection of all the tags used on the website or blog and each tag is a link and links to the tag overview page, where all the tagged posts are shown.

Since this collection of all tags should be available where ever I like to use it, it shouldn't be added to the pages meta data, but to the app data.

Within the `src/plugins/tags/index.js` I adjust the content of the `getAppData()` function.

```javascript
// src/plugins/tags/index.js
...

const getAppData = data => {
    if (data.app !== null && typeof data.app === 'object') {
        return Object.assign({}, data.app, {
            tagCloud: getTagCloud(data.pagesData, data.app)
        })
    }

    return data.app
}

...
```

The only thing I do here is to add a new property to the global `data.app` object. This new property `tagCloud` receives it's value from the `getTagCloud()` function.

```javascript
// src/plugins/tags/index.js

...

const getTagCloud = (pagesData, app) => {
    const tagCloud = app.tagCloud ? [...app.tagCloud] : []

    pagesData.filter(({ meta }) => meta[metaPropertyName])
        .forEach(({ meta }) => {
            meta[metaPropertyName].split(tagSeparator)
                .map(tag => tag.trim())
                .forEach(tag => {
                    if (!tagCloud.map(tag => tag.name).includes(tag)) {
                        tagCloud.push({
                            name: tag,
                            href: getTagHref(tagOverviewPath, tag)
                        })
                    }
                })
        })

    return tagCloud.sort((a, b) => a.name > b.name)
}

...
```

In the `getTagCloud()` function I at first set the `tagCloud` array, which will include what already exists in the `app.tagCloud` property or will be empty, if there is no `app.tagCloud` property yet.

To get all existing tags from all pages, I need to loop through the whole `pagesData` and filter out the pages which have a tag (or whatever name was set in the config) property set in their meta section. Then loop again only through the pages which have tags and take the value of this meta property, split it by the separator (also from config or default) with `split(tagSeparator)`,  remove whitespace with `tag.trim()` and finally add a small object with name and href to the `tagCloud` if the tag doesn't exist already.  
The function returns an alphabetically sorted array with tag objects including name and href.

Of course there is also a template again, which can be used to render all the links of the tag cloud where ever needed.

```pug
//- src/plugins/tags/views/partials/tag-cloud.pug

if app.tagCloud.length > 0
    each tag in app.tagCloud
        a(href=tag.href) #{ tag.name }
```

It is basically the same as `the tag-link-list.pug` template, but here I loop through the `app.tagCloud` array.

Now I include the template in the `views/pages/default.pug` template and check the result in the browser.

![Screenshot of page layout with included tag cloud template](/img/for-developers/create-advanced-plugin/Screenshot-of-page-layout-with-included-tag-cloud-template.png)

![Screenshot of example page with tag cloud at the bottom](/img/for-developers/create-advanced-plugin/Screenshot-of-example-page-with-tag-cloud-at-the-bottom.png)

* * *

Finally I will create the tag overview pages now. Because at the moment every link either in the tag link list or in the tag cloud will lead to a 404 page.

Since this plugin is all about tags it should also take care of creating all the tag overview pages automatically. In Nera a page is basically an entry in the `data.pagesData` array, I can easily add pages by adding additional objects to this array. As I already mentioned, the `getMetaData()` function is handling the `pagesData` so I will add more functionality to this function right now.

```javascript
// src/plugins/tags/index.js

...

const getMetaData = data => {
    if (data.pagesData !== null && typeof data.pagesData === 'object') {
        
        // Generate tag overview pages
        const tagCloud = getTagCloud(data.pagesData, data.app)
        tagCloud.forEach(tag => {
            data.pagesData.push({
                content: '',
                meta: {
                    layout: tagOverviewLayout,
                    title: tag.name,
                    createdAt: new Date(),
                    href: getTagHref(tagOverviewPath, tag.name),
                    pagePathName: tagOverviewPath.replace('/', ''),
                    tag: tag.name,
                    taggedPages: getTaggedPages(data.pagesData, tag.name),
                }
            })
        })
        
        data.pagesData = data.pagesData.map(({ content, meta }) => ({
            content,
            meta: Object.assign({}, meta, {
                tagLinks: getTagLinks(meta[metaPropertyName])
            })
        }))
    }

    return data.pagesData
}
...
```

At first I use the already existing `getTagCloud()` function to know how many tag overview pages need to be created.  
I just loop through the returned array and add a page object with empty content and meta section to the `data.pagesData` property for each tag. The meta section needs to have some required properties, like `layout` (defined in the config or the default value of `pages/default.pug` is used), `title`, `createdAt`, 'htmlPathName` (same as `href` - is actually deprecated, but still not removed from Nera core), `href` (which is just the href to the created page), `pagePathName` (also defined in the config or the default `/tags` is used) and `dirname` (same as `pagePathName` -  is actually deprecated, but still not removed from Nera core).   
The two properties `tag` and `taggedPages` are not required, but are used on the tag overview page, where `tag` just holds the tag name and `taggedPages` includes all pages related to this tag overview page.

The `getTaggedPages()` function just returns the pages which have the related tag in their meta tag property.

```javascript
// src/plugins/tags/index.js

...

const getTaggedPages = (pagesData, tag) => {
    return pagesData.filter(({ meta }) => meta[metaPropertyName]
        && meta[metaPropertyName].includes(tag))
        .sort((a, b) => new Date(b.meta.createdAt) - new Date(a.meta.createdAt))
}

...
```

So the final `src/plugins/tags/index.js` file looks like follows.

```javascript
// src/plugins/tags/index.js

const { getConfig } = require('../plugin-helper')

module.exports = (() => {
    const config = getConfig(`${__dirname}/config/tags.yaml`)
    const metaPropertyName = config.meta_property_name || 'tags'
    const tagSeparator = config.tag_separator || ','
    const tagOverviewPath = config.tag_overview_path || '/tags'
    const tagOverviewLayout = config.tag_overview_layout || 'pages/default.pug'

    const getTagHref = (path, tag) => `${path}/${tag.toLowerCase()}.html`

    const getTagLinks = tags => {
        if (!tags) return []

        return tags.split(tagSeparator).map(tag => ({
            name: tag.trim(),
            href: getTagHref(tagOverviewPath, tag.trim())
        }))
    }

    const getTagCloud = (pagesData, app) => {
        const tagCloud = app.tagCloud ? [...app.tagCloud] : []

        pagesData.filter(({ meta }) => meta[metaPropertyName])
            .forEach(({ meta }) => {
                meta[metaPropertyName].split(tagSeparator)
                    .map(tag => tag.trim())
                    .forEach(tag => {
                        if (!tagCloud.map(tag => tag.name).includes(tag)) {
                            tagCloud.push({
                                name: tag,
                                href: getTagHref(tagOverviewPath, tag)
                            })
                        }
                    })
            })

        return tagCloud.sort((a, b) => a.name > b.name)
    }

    const getTaggedPages = (pagesData, tag) => {
        return pagesData.filter(({ meta }) => meta[metaPropertyName]
            && meta[metaPropertyName].includes(tag))
            .sort((a, b) => new Date(b.meta.createdAt) - new Date(a.meta.createdAt))
    }

    const getAppData = data => {
        if (data.app !== null && typeof data.app === 'object') {
            return Object.assign({}, data.app, {
                tagCloud: getTagCloud(data.pagesData, data.app)
            })
        }

        return data.app
    }

    const getMetaData = data => {
        if (data.pagesData !== null && typeof data.pagesData === 'object') {
            
            // Generate tag overview pages
            const tagCloud = getTagCloud(data.pagesData, data.app)
            tagCloud.forEach(tag => {
                data.pagesData.push({
                    content: '',
                    meta: {
                        layout: tagOverviewLayout,
                        title: tag.name,
                        createdAt: new Date(),
                        href: getTagHref(tagOverviewPath, tag.name),
                        pagePathName: tagOverviewPath.replace('/', ''),
                        tag: tag.name,
                        taggedPages: getTaggedPages(data.pagesData, tag.name),
                    }
                })
            })
            
            data.pagesData = data.pagesData.map(({ content, meta }) => ({
                content,
                meta: Object.assign({}, meta, {
                    tagLinks: getTagLinks(meta[metaPropertyName])
                })
            }))
        }

        return data.pagesData
    }

    return {
        getAppData,
        getMetaData
    }
})()
```

Finally I will create a dedicated template file for the tag overview pages.

```pug
//- src/plugins/tags/views/pages/tag-overview.pug

h1 #{ meta.title }

section
    if meta.taggedPages.length > 0
        each page in meta.taggedPages
            article
                // Use what ever porperties you add in your pages meta section here
                h2 #{ page.meta.title }

                span #{ page.meta.createdAt.toLocaleString(app.lang) }

                p #{ page.meta.description }

                a(href=`${ page.meta.href }`) Read more
```

To use this I need to create a `src/plugins/tags/config/tags.yaml` with the `tag_overview_layout: ../src/plugins/tags/views/tag-overview.pug`. This way the plugin will use the about template to create the tag overview pages.

![Screenshot of tags plugin config file](/img/for-developers/create-advanced-plugin/Screenshot-of-tags-plugin-config-file.png)

Now everything is ready and if I check the pages in the browser by e.g. clicking on the post link in the tag cloud of my first example page, I get the tag overview page which shows very basic "teasers" of the related pages.

![Screenshot of example tag overview page for pages tagged with post](/img/for-developers/create-advanced-plugin/Screenshot-of-example-tag-overview-page-for-pages-tagged-with-post.png)

A pure HTML tag overview page for pages which where tagged with "post". Of course in "real life" it would look much better with nice styles.

But with this I'm done with the development of this Nera plugin. Find the final and polished result as [Nera tags plugin](https://medium.com/r/?url=https%3A%2F%2Fgithub.com%2Fseebaermichi%2Fnera-plugin-tags) on github.
